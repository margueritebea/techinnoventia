{% load static %}
<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <title>{% block title %}TechInnoventia{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        [x-cloak] { display: none !important; }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body class="bg-slate-50 text-slate-600 antialiased min-h-screen flex flex-col">

    {% include 'partials/navbar.html' %}

    {% if messages %}
    <div class="fixed top-20 right-4 z-50 w-full max-w-sm space-y-2">
        {% for message in messages %}
        <div x-data="{ show: true }" x-show="show" x-init="setTimeout(() => show = false, 4000)"
             class="p-4 rounded-xl shadow-lg border text-sm flex items-center justify-between
             {% if message.tags == 'error' %}bg-white border-red-100 text-red-600{% else %}bg-white border-blue-100 text-blue-600{% endif %}">
            <span>{{ message }}</span>
            <button @click="show = false" class="text-slate-400 hover:text-slate-600">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <main class="flex-grow pt-20 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto w-full">
        {% block content %}{% endblock %}
    </main>

    <footer class="bg-white border-t border-slate-200 mt-auto">
        <div class="max-w-7xl mx-auto px-4 py-8 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded bg-slate-900 text-white flex items-center justify-center text-xs font-bold">TI</div>
                <span class="text-sm font-semibold text-slate-800">TechInnoventia</span>
            </div>
            <p class="text-xs text-slate-500">© {% now "Y" %} Tous droits réservés.</p>
        </div>
    </footer>


        <!-- ================= SCRIPTS ================= -->
    <script>
    function getCSRF(){
        return document.querySelector("meta[name='csrf-token']").content;
    }




    document.addEventListener('alpine:init', () => {
        Alpine.data('auth', () => ({
            user: null,
            loading: false,

            async init() {
                // Vérifier l'authentification au chargement
                await this.checkAuth();
            },

            async checkAuth() {
                try {
                    const response = await fetch('/users/api/check-auth/', {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        this.user = null;
                        return;
                    }

                    const data = await response.json();
                    console.log("data: " + data)
                    if (data.authenticated) {
                        this.user = data.user;
                        window.user = data.user; // Disponible globalement
                    }
                } catch (error) {
                    console.error('Erreur de vérification auth:', error);
                    this.user = null;
                }
            },

            async logout() {
                try {
                    const response = await fetch('/users/api/logout/', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'X-CSRFToken': getCSRF()
                        }
                    });

                    this.user = null;
                    window.user = null;
                    window.location.href = '/';
                } catch (error) {
                    console.error('Erreur de déconnexion:', error);
                }
            }
        }));
    });
    </script>

        <!-- Scripts personnalisés -->
    {% block extra_js %}{% endblock %}
</body>
</html>
