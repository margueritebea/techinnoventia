{% load static %}
<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <!-- ===== META TECHNIQUES ===== -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- ===== SEO PRINCIPAL ===== -->
    <title>{% block title %}TechInnoventia - Programmation, Tech & Math{% endblock %}</title>
    <meta name="description" content="{% block description %}Actualités tech, articles sur la programmation, mathématiques, tutoriels et communauté développeurs.{% endblock %}">
    <meta name="keywords" content="Programmation, Tech, Math, IA, Actualité, Python, Django, Développement web">
    <meta name="author" content="TechInnoventia">

    <!-- ===== SEO EXTRA ===== -->
    <link rel="canonical" href="{{ request.build_absolute_uri }}">

    <!-- ===== OPEN GRAPH ===== -->
    <meta property="og:title" content="{% block og_title %}TechInnoventia{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Actualités, programmation, tech, math, communauté développeurs.{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:image" content="{% block og_image %}{% static 'img/og-default.jpg' %}{% endblock %}">
    <meta property="og:locale" content="fr_FR">

    <!-- ===== TWITTER CARD ===== -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}TechInnoventia{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}Programmation, tech, math et communauté.{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{% static 'img/og-default.jpg' %}{% endblock %}">

    <!-- ===== FAVICON ===== -->
    <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">

    <!-- ===== CSS ===== -->
    <link href="{% static 'css/base.css' %}" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- ===== BLOCKS CSS SUPPLÉMENTAIRES ===== -->
    {% block extra_css %}{% endblock %}
</head>

<body class="min-h-screen flex flex-col bg-base-200">

    <!-- ================= NAVBAR ================= -->
    {% include 'partials/navbar0.html' %}

    <!-- ================= ALERTES DJANGO ================= -->
    <div class="container mx-auto mt-4">
        {% if messages %}
        <div class="space-y-2">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} shadow">
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- ================= CONTENU PRINCIPAL ================= -->
    <main class="flex-grow container mx-auto px-4 py-6">
        {% block content %}

        {% endblock %}
    </main>

    <!-- ================= FOOTER ================= -->
    <footer class="footer footer-center p-4 bg-base-300 text-base-content mt-10">
        <aside>
            <p>© {{ now.year }} TechInnoventia - Tous droits réservés</p>
        </aside>
    </footer>

    <!-- ================= SCRIPTS ================= -->
<script>
function getCSRF(){
    return document.querySelector("meta[name='csrf-token']").content;
}




document.addEventListener('alpine:init', () => {
    Alpine.data('auth', () => ({
        user: null,
        loading: false,

        async init() {
            // Vérifier l'authentification au chargement
            await this.checkAuth();
        },

        async checkAuth() {
            try {
                const response = await fetch('/users/api/check-auth/', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    this.user = null;
                    return;
                }

                const data = await response.json();
                console.log("data: " + data)
                if (data.authenticated) {
                    this.user = data.user;
                    window.user = data.user; // Disponible globalement
                }
            } catch (error) {
                console.error('Erreur de vérification auth:', error);
                this.user = null;
            }
        },

        async logout() {
            try {
                const response = await fetch('/users/api/logout/', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'X-CSRFToken': getCSRF()
                    }
                });

                this.user = null;
                window.user = null;
                window.location.href = '/';
            } catch (error) {
                console.error('Erreur de déconnexion:', error);
            }
        }
    }));
});
</script>

    <!-- Scripts personnalisés -->
    {% block extra_js %}

    {% endblock %}

</body>
</html>
